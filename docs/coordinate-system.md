## レーダー座標系・スケール仕様（NMベース） ver.0.5

本仕様は「レーダースイープなし（常時全域更新）」の固定表示レーダー画面における座標系・スケール・方位・オーバーレイの取り扱いを定義する。描画・演算は局所平面（ENU想定）で十分とし、20–50 NM の範囲では地球曲率の影響を無視する。

### 1. 画面・原点・軸の定義
- 原点: レーダー表示の幾何学的中心（`screenCenter`）。ここが距離 0 NM。
- 画面座標系（ピクセル）:
  - x軸: 右方向が正
  - y軸: 下方向が正（Canvas/DOM の標準に合わせる）
- レーダー極座標系（距離 r [NM], 方位 θ [deg]）:
  - 距離 r: 原点からの距離 [NM]
  - 方位 θ: 北=0°, 東=90°, 南=180°, 西=270°、時計回り正（航空用方位基準）

注意: 画面 y 軸と数学的 y 軸は符号が逆になるため、極→直交変換で y 成分の符号反転が必要。

### 2. スケール（NM→px）
- 表示スケールは 2 モード:
  - 20 NM モード: 画面内最大半径 = 20 NM
  - 50 NM モード: 画面内最大半径 = 50 NM
- 基本レンジリング:
  - 20 NM モード: 半径 0 / 10 / 20 NM
  - 50 NM モード: 半径 0 / 10 / 20 / 30 / 40 / 50 NM
- ピクセル換算:
  - `radiusPx = min(viewportWidth, viewportHeight) * 0.48` とし、上下左右に 4% 程度の余白を確保
  - `pxPerNm = radiusPx / rangeNm`（`rangeNm` は 20 または 50）
  - `nmToPx(dNm) = dNm * pxPerNm`
  - `pxToNm(dPx) = dPx / pxPerNm`

補足: 本アプリは相対距離表示のみを行い、地理座標（緯度経度）からの投影は扱わない。ウィンドウ DPI やリサイズは `devicePixelRatio` を用いて反映する。

### 3. 座標変換
- 極→画面直交（航空方位 θ、時計回り正、北=0°）:
  - 数学直交（x右正、y上正）で
    - `x_math = r * sin(θ)`
    - `y_math = r * cos(θ)`
  - 画面座標（y下正）へ変換:
    - `x_screen = screenCenter.x + nmToPx(x_math)`
    - `y_screen = screenCenter.y - nmToPx(y_math)`
- 画面直交→極:
  - `dx_px = x_screen - screenCenter.x`
  - `dy_px = screenCenter.y - y_screen`
  - `dx_nm = pxToNm(dx_px)`
  - `dy_nm = pxToNm(dy_px)`
  - `r = sqrt(dx_nm^2 + dy_nm^2)`
  - `θ = atan2(dx_nm, dy_nm)` を度に変換し、[0, 360) に正規化

実装補助（擬似コード）:
```
function polarToScreen(rNm, bearingDeg):
  rad = degToRad(bearingDeg)
  xNm = rNm * sin(rad)
  yNm = rNm * cos(rad)
  return {
    x: cx + nmToPx(xNm),
    y: cy - nmToPx(yNm)
  }

function screenToPolar(x, y):
  dxPx = x - cx
  dyPx = cy - y
  dxNm = pxToNm(dxPx)
  dyNm = pxToNm(dyPx)
  rNm = hypot(dxNm, dyNm)
  bearingRad = atan2(dxNm, dyNm)
  bearingDeg = normalizeBearingDeg(radToDeg(bearingRad))
  return { rNm, bearingDeg }
```

### 4. レーダーオーバーレイ（PCA 対応）
- 同心円: 10〜80 NM を 10 NM 刻みで描画。5 本目（50 NM）は濃い青・太線、それ以外は淡い青。
- 南向き長方形: 方位 180° を中心に、5–15 NM・幅 ±2 NM の帯を淡い青で描画。
- 扇形（バウムクーヘン型）: 半径 20–25 NM、弧長 10 NM（内側 20 NM 基準）を方位 180° を中心に配置し、薄い青で塗りつぶす。
- すべて `pxPerNm` を用いた極座標描画。レンジ切替・リサイズ時には再計算する。

### 5. 航空機シンボル・ラベル
- シンボル: 黄色の円（白の薄いリム付き）。半径は 4px（DPR 補正あり）。
- 進行方向スリット: シンボル後方に 3 本の短い白線を描画し、針路方向を強調。
- ヘディングライン: 針路方向に 2 NM 分の白線を追加表示。
- ラベル:
  - 内容: 1 行目 = コールサイン、2 行目 = `HDG ddd`（000°は 360 と表示）。
  - フォント: 等幅（UI モノスペース）、白文字。コネクタ線はなし。
  - 位置: シンボル右上へ (14px, -14px) オフセットで固定配置。
- ラベルのヘディング値は `targetHeadingDeg` が存在する場合それを表示し、未指定時は `headingDeg` を使用する。

### 6. 範囲外の扱い
- シミュレーションでは `r > rangeNm` が発生し得る。
- 現仕様ではクリッピングのみを行い、端点マーカー等は未実装。

### 7. スケール切替（20 NM / 50 NM）
- ユーザー操作で 20 / 50 NM を切替。
- 切替時に `pxPerNm` を再計算し、航空機・グリッド・オーバーレイを再描画。
- アニメーションは任意（現実装では静的切替）。

### 8. 更新周期と描画
- 位置更新周期: 4 秒（全機一斉更新）。
- 描画: 4 秒間隔の更新に加え、レンジ切替・ウィンドウリサイズ・指示操作で随時再描画。
- `requestAnimationFrame` によるスムージングは現状不要。

### 9. 単位と丸め
- 距離: NM（海里）。
- 速度: ノット（kt, NM/h）。画面表示は 10 kt 単位（例: `36` -> 360 kt）。
- 方位: 度（北=0°、時計回り正）。
- 高度: 100 ft 単位（`H`）。UI で入力・指示可能だがラベル表示は未実装。

### 10. テスト・検証観点（抜粋）
- 北(0°), 東(90°), 南(180°), 西(270°) での極→画面変換が期待通りか。
- 1, 10, 20, 50 NM のリング位置が正しいか。
- スケール切替で相対配置が維持されるか（中央固定）。
- PCA オーバーレイ（同心円／長方形／扇形）が指定方位・半径で描画されるか。
- 画面端でラベル配置が破綻しないか（固定オフセット）。

---

次フェーズ（別仕様「航空機の運動モデル」）で、針路・速度・高度指示をこの座標系上でどのように時間離散で更新するか（4 秒ステップ）を定義する。
